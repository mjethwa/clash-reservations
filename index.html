<!DOCTYPE html>
<html lang="en-us">
    <head>
        <meta charset="UTF-8">
        <title>Clash Reservations</title>
        
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="stylesheet" href="css/w3.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" />

        <style>
            .mj-col-button {
                width:50px;
                overflow:hidden;
            }
            .mj-col-tag {
                width:100px;
                overflow:hidden;
            }
            .mj-half-scroll{
                max-height:50vh;
                overflow:scroll;
            }
        
            /*medium*/
            @media only screen and (min-width:601px){
                .mj-col-button {
                    width:75px;
                    overflow:hidden;
                }
                .mj-col-tag {
                    width:150px;
                    overflow:hidden;
                }
            }
            /*large*/
            @media only screen and (min-width:993px){
                .mj-col-button {
                    width:100px;
                    overflow:hidden;
                }
                .mj-col-tag {
                    width:200px;
                    overflow:hidden;
                }
            }
        </style>

        <!-- Angular -->
        <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.15/angular.min.js"></script>
        <!-- Firebase -->
        <script src="https://cdn.firebase.com/js/client/2.2.4/firebase.js"></script>
        <!-- AngularFire -->
        <script src="https://cdn.firebase.com/libs/angularfire/1.2.0/angularfire.min.js"></script>

        <script src="javascript/lib.js"></script>

        <script type="text/javascript">

            var oCookies = getCookies();
            var oArguments = getArguments();
            console.log(oArguments["resvCode"]);

            var app = angular.module("reserveApp", ["firebase"]);

            app.controller("reserveCtrl", ["$scope", "$timeout", "$firebaseArray",
                function ($scope, $timeout, $firebaseArray) {
                    $scope.setResvCode = function (resvCode, mustExist) {
                        if (!resvCode) return false;

                        $scope.oCommonData.sResvCode = resvCode;
                        setCookie("resvCode",resvCode);
                        return true;
                    }

                    $scope.unsetResvCode = function () {
                        $scope.oCommonData.sResvCode = null;
                        setCookie("resvCode", '');
                        return true;
                    }

                    $scope.oCommonData = { sResvCode: null };

                    $scope.setResvCode(oArguments["resvCode"], true);
                    
                    $scope.updateServerTime = function () {
                        $scope.serverTime = (new Date()).getTime();
                        $timeout($scope.updateServerTime, 60000);
                    };
                    $scope.updateServerTime(); //trigger the polling
                    $scope.getServerTime = function () {
                        //return (new Date()).getTime();
                        return $scope.serverTime;
                    };

                                           
                    /*
                    data_paths:
                     
                    {resvCode}/oWarInfo/sClanName
                    {resvCode}/oWarInfo/sOppositionClanName
                    {resvCode}/oWarInfo/iWarSize
                    {resvCode}/oWarInfo/sTimerType
                                            
                    {resvCode}/loOpponents/{0-n}/$id  //generated by firebase for Arrays
                    {resvCode}/loOpponents/{0-n}/sOpponentName
                    {resvCode}/loOpponents/{0-n}/loResvs/{0-n}/$id   //generated by firebase for Arrays
                    {resvCode}/loOpponents/{0-n}/loResvs/{0-n}/sPlayerName
                    {resvCode}/loOpponents/{0-n}/loResvs/{0-n}/iResult
                    {resvCode}/loOpponents/{0-n}/loResvs/{0-n}/iResvTime
                    */
                                           
                    $scope.oWarInfo = {
                        sClanName:"Super Clanny",
                        sOppositionClanName:null,
                        iWarSize:15,
                        sTimerType:"fixed-2-h"
                    };
                                           
                    $scope.loOpponents = [
                        { $id: 0, sOpponentName: "p1", loResvs: [{ $id: 0, sPlayerName: "Joe", iResult: 2, iResvTime: $scope.getServerTime() }, { $id: 1, sPlayerName: "James", iResult: null, iResvTime: $scope.getServerTime() }] },
                        { $id: 1, sOpponentName: "p2", loResvs: [{ $id: 0, sPlayerName: "Joe", iResult: 0, iResvTime: $scope.getServerTime() }, { $id: 1, sPlayerName: "James", iResult: null, iResvTime: $scope.getServerTime() }] },
                        { $id: 2, sOpponentName: "p3", loResvs: [] },
                        { $id: 3, sOpponentName: "p4", loResvs: [{ $id: 0, sPlayerName: "Joe", iResult: 1, iResvTime: $scope.getServerTime() }] },
                        { $id: 4, sOpponentName: "p5" },
                        { $id: 5, sOpponentName: "p6", loResvs: [{ $id: 0, sPlayerName: "Jim", iResult: 1, iResvTime: $scope.getServerTime() }, { $id: 1, sPlayerName: "John", iResult: null, iResvTime: $scope.getServerTime() }] },
                        ];
                       
                    //configs
                    $scope.loWarSizes = [
                        {val:"10", txt:"10 v 10"},
                        {val:"15", txt:"15 v 15"},
                        {val:"20", txt:"20 v 20"},
                        {val:"25", txt:"25 v 25"},
                        {val:"30", txt:"30 v 30"},
                        {val:"40", txt:"40 v 40"},
                        {val:"50", txt:"50 v 50"}
                        ];
                    $scope.loTimerTypes = [
                        {val:"fixed-30-m", txt:"30 mins"},
                        {val:"fixed-1-h", txt:"1 hour"},
                        {val:"fixed-2-h", txt:"2 hours"},
                        {val:"fixed-3-h", txt:"3 hours"},
                        {val:"fixed-4-h", txt:"4 hours"},
                        {val:"fixed-5-h", txt:"5 hours"},
                        {val:"fixed-6-h", txt:"6 hours"},
                        {val:"fixed-12-h", txt:"12 hours"},
                        {val:"fixed-24-h", txt:"24 hours"}
                        ];
 
                }]);

            app.controller("reserveInitCtrl", ["$scope", "$firebaseArray",
                function ($scope, $firebaseArray) {


                    $scope.onCreateOption = function () {
                        //$scope.sResvCode = generateCode();
                        $scope.iPageMode = 1;
                    };

                    $scope.onJoinOption = function () {
                        $scope.iPageMode = 2;
                    }

                    $scope.onCancelOption = function () {
                        $scope.iPageMode = 0;
                    };

                    $scope.isOptionPending = function () {
                        return (!$scope.iPageMode);
                    };

                    $scope.isOptionCreate = function () {
                        return ($scope.iPageMode == 1);
                    };

                    $scope.isOptionJoin = function () {
                        return ($scope.iPageMode == 2);
                    };

                    $scope.onCreateRequested = function () {
                        //$scope.oCommonData.sResvCode = generateCode();
                        $scope.setResvCode(generateCode(), false);
                    }

                    $scope.onJoinRequested = function () {
                        //$scope.oCommonData.sResvCode = $scope.sInputResvCode;
                        $scope.setResvCode($scope.sInputResvCode, true);
                    }

                }]);


            app.controller("reserveListCtrl", ["$scope", "$firebaseArray",
                function ($scope, $firebaseArray) {

                    $scope.onLeaveOption = function () {                     
                        $scope.onDeSelectOpponent();
                        $scope.unsetResvCode();
                    };

                    $scope.onOpponentSelected = function (opponent) {
                        $scope.oSelectedOpponent = ($scope.oSelectedOpponent == opponent ? null : opponent);
                    }
                    $scope.onDeSelectOpponent = function () {
                        $scope.onUpdateResvCancel();
                        $scope.oSelectedOpponent = null;
                    }

                    $scope.onUpdateResvOption = function (resv) {
                        $scope.oSelectedResv = (resv == $scope.oUpdateResv ? null : resv);
                        $scope.iStars = resv.iResult;
                    };
                    $scope.onRemoveResvOption = function (resv) {

                    };
                    $scope.onAddResv = function () {
                        if (!$scope.oSelectedOpponent.loResvs) $scope.oSelectedOpponent.loResvs = [];
                        var resvId = $scope.oSelectedOpponent.loResvs.length;
                        $scope.oSelectedOpponent.loResvs.push({ $id: resvId, sPlayerName: $scope.sName, iResvTime: $scope.getServerTime() });
                    };
                    $scope.onSaveResv = function (resv) {
                        //$scope.$apply();
                        $scope.oSelectedResv.iResult = $scope.iStars;
                        $scope.oSelectedResv = null;
                    };
                    $scope.onRenewResv = function (resv) {
                        $scope.oSelectedResv.iResvTime = $scope.getServerTime();
                        $scope.oSelectedResv = null;
                    };
                    $scope.onUpdateResvCancel = function (resv) {
                        $scope.oSelectedResv = null;
                    };

                    $scope.getElapsedMinutes = function (resv) {
                        return Math.floor(($scope.getServerTime() - resv.iResvTime) / 60000);
                    };


                }]);

        </script>
    </head>
    <body>
        <div ng-app="reserveApp" ng-controller="reserveCtrl">
            <div class="w3-container" ng-controller="reserveInitCtrl" ng-show="!oCommonData.sResvCode">
                <div class="w3-panel" ng-show="isOptionPending()">
                    <button class="w3-btn" ng-click="onCreateOption()">Create</button>
                    <button class="w3-btn" ng-click="onJoinOption()">Join</button>
                </div>

                <div class="w3-panel" ng-show="!isOptionPending()">
                    <button class="w3-btn" ng-click="onCancelOption()"><i class="fa fa-undo"></i></button>
                </div>

                <div class="w3-panel" ng-show="isOptionCreate()">
                    <input class="w3-input" placeholder="Clan Name" ng-model="sClanName"/>
                    <input class="w3-input" placeholder="Enemy Clan Name" ng-model="sOppositionClanName" />
                    <select class="w3-select" ng-model="iWarSize">
                        <option value="" disabled selected>Choose the war size ...</option>
                        <option ng-repeat="opt in loWarSizes" value="{{opt.val}}">{{opt.txt}}</option>
                    </select>
                    <select class="w3-select" ng-model="sTimerType">
                        <option value="" disabled selected>Choose timer type ...</option>
                        <option ng-repeat="opt in loTimerTypes" value="{{opt.val}}">{{opt.txt}}</option>
                    </select>
                    <button class="w3-btn" ng-click="onCreateRequested()">Submit</button>
                </div>

                <div class="w3-panel" ng-show="isOptionJoin()">
                    <input class="w3-input" placeholder="Reserve Code" ng-model="sInputResvCode"/>
                    <button class="w3-btn" ng-click="onJoinRequested()">Submit</button>
                </div>

            </div>
            <div class="w3-container" ng-controller="reserveListCtrl" ng-show="oCommonData.sResvCode">
                <div class="w3-panel">
                    <button class="w3-btn" ng-click="onLeaveOption()"><i class="fa fa-undo"></i></button>
                    <span class="w3-tag w3-padding w3-margin-top w3-round-large">Code {{ oCommonData.sResvCode }}</span>
                    <span class="w3-tag w3-padding w3-margin-top w3-round-large">{{ (oWarInfo.sClanName ? oWarInfo.sClanName : "Your Clan" ) }} v {{ (oWarInfo.sOppositionClanName ? oWarInfo.sOppositionClanName : "Opposition") }}</span>
                    <span class="w3-tag w3-padding w3-margin-top w3-round-large">Timer {{ oWarInfo.sTimerType }}</span>
                </div>
                

                <ul class="w3-ul">
                    <li ng-repeat="opponent in loOpponents">
                        <div class="w3-row-padding">
                            <div class="w3-col mj-col-button">
                                <a class="w3-btn" ng-click="onOpponentSelected(opponent)"><i class="fa fa-pencil"></i></a>
                            </div>  
                            <div class="w3-col mj-col-tag">
                                <span class="w3-tag w3-padding w3-round-large">{{ $index }}. {{ opponent.sOpponentName }}</span>
                            </div>
                            <div class="w3-rest w3-row-padding">
                                <div class="w3-col mj-col-tag" ng-repeat="resv in opponent.loResvs">
                                    <div class="w3-tag w3-grey">
                                        <span>{{resv.sPlayerName}}:</span>
                                        <span ng-if="resv.iResult || resv.iResult == 0">{{resv.iResult}}</span>
                                        <span ng-if="!(resv.iResult || resv.iResult == 0) && resv.iResvTime">{{getElapsedMinutes(resv)}}min ago</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </li>
                </ul>

                <div class="w3-bottom w3-container w3-border w3-padding-16 w3-white" ng-show="oSelectedOpponent">
                    <button class="w3-btn" ng-click="onDeSelectOpponent()"><i class="fa fa-times"></i></button>
                    <span class="w3-tag w3-padding w3-round-large">Opponent: {{ oSelectedOpponent.sOpponentName }}</span>

                    
                    <div class="w3-panel" ng-show="!oSelectedResv">
                        <input placeholder="name" ng-model="sName" />
                        <button class="w3-btn" ng-click="onAddResv()">Add</button>
                    </div>

                    <div class="mj-half-scroll">
                        <ul class="w3-ul" ng-show="!oSelectedResv">
                            <li ng-repeat="resv in oSelectedOpponent.loResvs | orderBy:'$id':true">
                                <div class="w3-row-padding">
                                    <div class="w3-col mj-col-button">
                                        <button class="w3-btn" ng-click="onUpdateResvOption(resv)"><i class="fa fa-pencil"></i></button>
                                    </div>

                                    <!--<div class="w3-rest">{{resv.sPlayerName}} : {{resv.iResult}}</div>-->

                                    <div class="w3-rest w3-tag w3-grey">
                                        <span>{{resv.sPlayerName}}:</span>
                                        <span ng-if="resv.iResult || resv.iResult == 0">{{resv.iResult}}</span>
                                        <span ng-if="!(resv.iResult || resv.iResult == 0) && resv.iResvTime">{{getElapsedMinutes(resv)}}min ago</span>
                                    </div>
                                </div>
                            </li>
                        </ul>
                    </div>

                    
                    <div class="w3-panel w3-border" ng-show="oSelectedResv">
                        <div class="w3-panel">
                            <button class="w3-btn" ng-click="onUpdateResvCancel(oSelectedResv)"><i class="fa fa-undo"></i></button>
                            <span class="w3-tag w3-padding w3-round-large">Player: {{ oSelectedResv.sPlayerName }}</span>
                        </div>
                        <div class="w3-panel">
                            <input placeholder="stars" ng-model="iStars"></input>
                            <button class="w3-btn" ng-click="onSaveResv(oSelectedResv)">Save</button>
                        </div>
                        <div class="w3-panel">
                            <button class="w3-btn" ng-click="onRenewResv(oSelectedResv)">Renew</button>
                            <button class="w3-btn" ng-click="onRemoveResvOption(oSelectedResv)">Remove</button>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </body>
</html>
