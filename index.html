<!DOCTYPE html>
<html lang="en-us">
    <head>
        <meta charset="UTF-8">
        <title>Clash Reservations</title>
        
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="stylesheet" href="http://www.w3schools.com/lib/w3.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" />

        <!-- Angular -->
        <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.15/angular.min.js"></script>
        <!-- Firebase -->
        <script src="https://cdn.firebase.com/js/client/2.2.4/firebase.js"></script>
        <!-- AngularFire -->
        <script src="https://cdn.firebase.com/libs/angularfire/1.2.0/angularfire.min.js"></script>

        <script type="text/javascript">

            function generateCode() {
                var vowels = "aeiou";
                var consonents = "bcdfghjklmnpqrstvwxyz";
                var digits = "0123456789";

                var result = "";

                result = result.concat(
                    randomChar(consonents), randomChar(vowels),
                    randomChar(consonents), randomChar(vowels),
                    randomChar(consonents), randomChar(vowels),
                    randomChar(digits), randomChar(digits)
                    );

                return result;

            }

            function randomChar(fromString) {
                if (!fromString) return null;
                return fromString.charAt(Math.floor(Math.random() * fromString.length));
            }


            function getCookies() {
                var result = {};

                var c = document.cookie.split('; ');
                for (i = c.length - 1; i >= 0; i--) {
                    var C = c[i].split('=');
                    result[C[0]] = C[1];
                }

                return result;
            }

            function setCookie(cKey, cVal) {
                if (typeof (cKey) != "string" || typeof (cVal) != "string") {
                    console.log("Attempted to set cookie with non string values");
                    return;
                }

                document.cookie = cKey + "=" + cVal + "; expires=Fri, 31 Dec 9999 23:59:59 GMT";
            }

            function getArguments() {

                var result = {};
                var sStr = window.location.search;

                if (sStr.startsWith("?")) sStr = sStr.substring(1);
                var c = sStr.split('&');
                for (i = c.length - 1; i >= 0; i--) {
                    var C = c[i].split('=');
                    result[C[0]] = C[1];
                }

                return result;
            }

        </script>

        <script type="text/javascript">

            var oCookies = getCookies();
            var oArguments = getArguments();
            console.log(oArguments["resvCode"]);

            var app = angular.module("reserveApp", ["firebase"]);

            app.controller("reserveCtrl", ["$scope", "$firebaseArray",
                function ($scope, $firebaseArray) {
                    $scope.setResvCode = function (resvCode, mustExist) {
                        if (!resvCode) return false;

                        $scope.oCommonData.sResvCode = resvCode;
                        setCookie("resvCode",resvCode);
                        return true;
                    }

                    $scope.unsetResvCode = function () {
                        $scope.oCommonData.sResvCode = null;
                        setCookie("resvCode", '');
                        return true;
                    }

                    $scope.oCommonData = { sResvCode: null };

                    $scope.setResvCode(oArguments["resvCode"], true);
 
                }]);

            app.controller("reserveInitCtrl", ["$scope", "$firebaseArray",
                function ($scope, $firebaseArray) {


                    $scope.onCreateOption = function () {
                        //$scope.sResvCode = generateCode();
                        $scope.iPageMode = 1;
                    };

                    $scope.onJoinOption = function () {
                        $scope.iPageMode = 2;
                    }

                    $scope.onCancelOption = function () {
                        $scope.iPageMode = 0;
                    };

                    $scope.isOptionPending = function () {
                        return (!$scope.iPageMode);
                    };

                    $scope.isOptionCreate = function () {
                        return ($scope.iPageMode == 1);
                    };

                    $scope.isOptionJoin = function () {
                        return ($scope.iPageMode == 2);
                    };

                }]);

            app.controller("reserveCreateCtrl", ["$scope", "$firebaseArray",
                function ($scope, $firebaseArray) {

                    $scope.onSubmit = function () {
                        //$scope.oCommonData.sResvCode = generateCode();
                        $scope.setResvCode(generateCode(), false);
                    }

                }]);

            app.controller("reserveJoinCtrl", ["$scope", "$firebaseArray",
                function ($scope, $firebaseArray) {

                    $scope.onSubmit = function () {
                        //$scope.oCommonData.sResvCode = $scope.sInputResvCode;
                        $scope.setResvCode($scope.sInputResvCode, true);
                    }

                }]);

            app.controller("reserveListCtrl", ["$scope", "$firebaseArray",
                function ($scope, $firebaseArray) {

                    /*
                    data_paths:

                    {resvCode}/oWarInfo/sClanName
                    {resvCode}/oWarInfo/sOppositionClanName
                    {resvCode}/oWarInfo/iWarSize
                    {resvCode}/oWarInfo/sTimerType

                    {resvCode}/loOpponents/{0-n}/$id  //generated by firebase for Arrays
                    {resvCode}/loOpponents/{0-n}/sOpponentName
                    {resvCode}/loOpponents/{0-n}/loResvs/{0-n}/$id   //generated by firebase for Arrays
                    {resvCode}/loOpponents/{0-n}/loResvs/{0-n}/sPlayerName
                    {resvCode}/loOpponents/{0-n}/loResvs/{0-n}/iResult
                    {resvCode}/loOpponents/{0-n}/loResvs/{0-n}/iResvTime
                    */

                    $scope.onCancelOption = function () {
                        $scope.unsetResvCode();
                    };

                    $scope.loOpponents = [
                        { $id: 0, sOpponentName: "p1", loResvs: [{ $id: 0, sPlayerName: "Joe", iResult: 2, iResvTime: 20000 }, { $id: 1, sPlayerName: "James", iResult: null, iResvTime: 20000 }] },
                        { $id: 1, sOpponentName: "p2", loResvs: [{ $id: 0, sPlayerName: "Joe", iResult: 0, iResvTime: 20000 }, { $id: 1, sPlayerName: "James", iResult: null, iResvTime: 20000 }] },
                        { $id: 2, sOpponentName: "p3", loResvs: [] },
                        { $id: 3, sOpponentName: "p4", loResvs: [{ $id: 0, sPlayerName: "Joe", iResult: 1, iResvTime: 20000 }] },
                        { $id: 4, sOpponentName: "p5", loResvs: [] },
                        { $id: 5, sOpponentName: "p6", loResvs: [{ $id: 0, sPlayerName: "Jim", iResult: 1, iResvTime: 20000 }, { $id: 1, sPlayerName: "John", iResult: null, iResvTime: 20000 }] },
                    ];
                                               

                    $scope.onOpponentSelected = function (opponent) {
                        $scope.oSelectedOpponent = ($scope.oSelectedOpponent == opponent ? null : opponent);
                    }
                    $scope.onDeSelectOpponent = function () {
                        $scope.oSelectedOpponent = null;
                    }
                }]);

            app.controller("reserveItemCtrl", ["$scope", "$firebaseArray",
                function ($scope, $firebaseArray) {
                                               
                    $scope.onUpdateOption = function (resv) {
                        $scope.oUpdateResv = (resv == $scope.oUpdateResv ? null : resv);
                    };
                    $scope.onRemoveOption = function (resv) {
                        $scope.oRemoveResv = resv;
                    };
                    $scope.onAdd = function () {
                        var resvId = $scope.oSelectedOpponent.loResvs.length;
                        $scope.oSelectedOpponent.loResvs.push({ $id: resvId, sPlayerName: $scope.sName, iResvTime: (new Date()).getTime()});
                    };
                    $scope.onSave = function (resv) {
                        //$scope.$apply();
                        $scope.oUpdateResv.iResult = $scope.iStars;
                        $scope.oUpdateResv = null;
                    };
                    $scope.onRenew = function (resv) {
                        $scope.oUpdateResv.iResvTime = (new Date()).getTime();
                        $scope.oUpdateResv = null;
                    };
                    $scope.onUpdateCancel = function (resv) {
                        $scope.oUpdateResv = null;
                    };


                }]);

        </script>
    </head>
    <body>
        <div ng-app="reserveApp" ng-controller="reserveCtrl">
            <div class="w3-container" ng-controller="reserveInitCtrl" ng-show="!oCommonData.sResvCode">
                <div class="w3-panel" ng-show="isOptionPending()">
                    <button class="w3-btn" ng-click="onCreateOption()">Create</button>
                    <button class="w3-btn" ng-click="onJoinOption()">Join</button>
                </div>

                <div class="w3-panel" ng-show="!isOptionPending()">
                    <button class="w3-btn" ng-click="onCancelOption()"><i class="fa fa-undo"></i></button>
                </div>

                <div class="w3-panel" ng-controller="reserveCreateCtrl" ng-show="isOptionCreate()">
                    <input class="w3-input" placeholder="Clan Name" ng-model="sClanName"/>
                    <input class="w3-input" placeholder="Enemy Clan Name" ng-model="sOppositionClanName" />
                    <select class="w3-select" ng-model="iWarSize">
                        <option value="" disabled selected>Choose the war size ...</option>
                        <option value="10" >10 v 10</option>
                        <option value="15" >15 v 15</option>
                        <option value="20" >20 v 20</option>
                        <option value="25" >25 v 25</option>
                        <option value="30" >30 v 30</option>
                        <option value="40" >40 v 40</option>
                        <option value="50" >50 v 50</option>
                    </select>
                    <select class="w3-select" ng-model="sTimerType">
                        <option value="" disabled selected>Choose timer type ...</option>
                        <option value="fixed:30m" >30 mins</option>
                        <option value="fixed:1h" >1 Hour</option>
                        <option value="fixed:2h" >2 Hours</option>
                        <option value="fixed:3h" >3 Hours</option>
                        <option value="fixed:4h" >4 Hours</option>
                        <option value="fixed:5h" >5 Hours</option>
                        <option value="fixed:6h" >6 Hours</option>
                        <option value="fixed:12h" >12 Hours</option>
                        <option value="fixed:24h" >24 Hours</option>
                    </select>
                    <button class="w3-btn" ng-click="onSubmit()">Submit</button>
                </div>

                <div class="w3-panel" ng-controller="reserveJoinCtrl" ng-show="isOptionJoin()">
                    <input class="w3-input" placeholder="Reserve Code" ng-model="sInputResvCode"/>
                    <button class="w3-btn" ng-click="onSubmit()">Submit</button>
                </div>

            </div>
            <div class="w3-container" ng-controller="reserveListCtrl" ng-show="oCommonData.sResvCode">
                <div class="w3-panel">
                    <button class="w3-btn" ng-click="onCancelOption()"><i class="fa fa-undo"></i></button>
                    <span class="w3-tag">Code {{ oCommonData.sResvCode }}</span>
                </div>
                

                <ul class="w3-ul">
                    <li ng-repeat="opponent in loOpponents">
                        <div class="w3-row-padding">
                            <div class="w3-col s1">
                                <a class="w3-btn" ng-click="onOpponentSelected(opponent)"><i class="fa fa-pencil"></i></a>
                            </div>  
                            <div class="w3-col s2">
                                <span class="w3-tag">{{ $index + '. ' + opponent.sOpponentName }}</span>
                            </div> 
                            <div class="w3-col s2" ng-repeat="resv in opponent.loResvs">
                                <span class="w3-grey">{{resv.sPlayerName}} : {{resv.iResult}}</span>
                            </div>
                        </div>
                    </li>
                </ul>

                <div class="w3-bottom w3-container w3-border w3-padding-16 w3-white" ng-controller="reserveItemCtrl" ng-show="oSelectedOpponent">
                    <button class="w3-btn" ng-click="onDeSelectOpponent()"><i class="fa fa-times"></i></button>
                    <div class="w3-panel">
                        <span class="w3-tag">You selected {{ oSelectedOpponent.sName }}</span>
                    </div>
                    
                    <div class="w3-panel">
                        <input placeholder="name" ng-model="sName" />
                        <button class="w3-btn" ng-click="onAdd()">Add</button>
                    </div>

                    <ul class="w3-ul">
                        <li ng-repeat="resv in oSelectedOpponent.loResvs | orderBy:'$id':true">
                            <div class="w3-row-padding">
                                <div class="w3-col s3">{{resv.sPlayerName}} : {{resv.iResult}}</div>
                                <div class="w3-col s6">
                                    <button class="w3-btn" ng-click="onUpdateOption(resv)">Update</button>
                                    <button class="w3-btn" ng-click="onRemoveOption(resv)">Remove</button>
                                </div>
                                <div class="w3-panel w3-col s6" ng-show="oUpdateResv == resv">
                                    <input placeholder="stars" ng-model="iStars" />
                                    <button class="w3-btn" ng-click="onSave(resv)">Save</button>
                                    <button class="w3-btn" ng-click="onRenew(resv)">Renew</button>
                                    <button class="w3-btn" ng-click="onUpdateCancel(resv)"><i class="fa fa-undo"></i></button>
                                </div>
                            </div>
                        </li>
                    </ul>

                </div>
            </div>
        </div>
    </body>
</html>
