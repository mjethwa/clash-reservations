<!DOCTYPE html>
<html lang="en-us">
    <head>
        <meta charset="UTF-8">
        <title>Clash Reservations</title>

        <!-- Angular -->
        <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.15/angular.min.js"></script>
        <!-- Firebase -->
        <script src="https://cdn.firebase.com/js/client/2.2.4/firebase.js"></script>
        <!-- AngularFire -->
        <script src="https://cdn.firebase.com/libs/angularfire/1.2.0/angularfire.min.js"></script>

        <script type="text/javascript">

            function generateCode() {
                var vowels = "aeiou";
                var consonents = "bcdfghjklmnpqrstvwxyz";
                var digits = "0123456789";

                var result = "";

                result = result.concat(
                    randomChar(consonents), randomChar(vowels),
                    randomChar(consonents), randomChar(vowels),
                    randomChar(consonents), randomChar(vowels),
                    randomChar(digits), randomChar(digits)
                    );

                return result;

            }

            function randomChar(fromString) {
                if (!fromString) return null;
                return fromString.charAt(Math.floor(Math.random() * fromString.length));
            }


            function getCookies() {
                var result = {};

                var c = document.cookie.split('; ');
                for (i = c.length - 1; i >= 0; i--) {
                    var C = c[i].split('=');
                    result[C[0]] = C[1];
                }

                return result;
            }

            function setCookie(cKey, cVal) {
                if (typeof (cKey) != "string" || typeof (cVal) != "string") {
                    console.log("Attempted to set cookie with non string values");
                    return;
                }

                document.cookie = cKey + "=" + cVal + "; expires=Fri, 31 Dec 9999 23:59:59 GMT";
            }

            function getArguments() {

                var result = {};
                var sStr = window.location.search;

                if (sStr.startsWith("?")) sStr = sStr.substring(1);
                var c = sStr.split('&');
                for (i = c.length - 1; i >= 0; i--) {
                    var C = c[i].split('=');
                    result[C[0]] = C[1];
                }

                return result;
            }

        </script>

        <script type="text/javascript">

            var oCookies = getCookies();
            var oArguments = getArguments();
            console.log(oArguments["resvCode"]);

            var app = angular.module("reserveApp", ["firebase"]);



            app.controller("reserveCtrl", ["$scope", "$firebaseArray",
                function ($scope, $firebaseArray) {
                    $scope.setResvCode = function (resvCode, mustExist) {
                        if (!resvCode) return false;

                        $scope.oCommonData.sResvCode = resvCode;
                        setCookie("resvCode",resvCode);
                        return true;
                    }

                    $scope.oCommonData = { sResvCode: null };

                    $scope.setResvCode(oArguments["resvCode"], true);
 
                }]);


            app.controller("reserveInitCtrl", ["$scope", "$firebaseArray",
                function ($scope, $firebaseArray) {


                    $scope.onCreate = function () {
                        //$scope.sResvCode = generateCode();
                        $scope.iPageMode = 1;
                    };

                    $scope.onJoin = function () {
                        $scope.iPageMode = 2;
                    }

                    $scope.onCancel = function () {
                        $scope.iPageMode = 0;
                    };

                }]);


            app.controller("reserveCreateCtrl", ["$scope", "$firebaseArray",
                function ($scope, $firebaseArray) {

                    $scope.onSubmit = function () {
                        //$scope.oCommonData.sResvCode = generateCode();
                        $scope.setResvCode(generateCode(), false);
                    }

                }]);


            app.controller("reserveJoinCtrl", ["$scope", "$firebaseArray",
                function ($scope, $firebaseArray) {

                    $scope.onSubmit = function () {
                        //$scope.oCommonData.sResvCode = $scope.sInputResvCode;
                        $scope.setResvCode($scope.sInputResvCode, true);
                    }

                }]);
            app.controller("reserveListCtrl", ["$scope", "$firebaseArray",
                function ($scope, $firebaseArray) {

                    $scope.opponents = [
                        { name: "p1", resvs: [{ state: "**" }, { state: "open" }] },
                        { name: "p2", resvs: [{ state: "*" }] },
                        { name: "p3", resvs: [{ state: "**" }, { state: "**" }, { state: "***" }] },
                    ];


                    $scope.onOpponentSelected = function () {

                    }
                }]);


            app.controller("reserveItemCtrl", ["$scope", "$firebaseArray",
                function ($scope, $firebaseArray) {


                }]);

        </script>
    </head>
    <body>
        <div ng-app="reserveApp" ng-controller="reserveCtrl">
            <div ng-controller="reserveInitCtrl" ng-show="!oCommonData.sResvCode">
                <div ng-show="!iPageMode">
                    <button ng-click="onCreate()">Create</button>
                    <button ng-click="onJoin()">Join</button>
                </div>

                <div ng-controller="reserveCreateCtrl" ng-show="iPageMode == 1">
                    Create stuff
                    <button ng-click="onSubmit()">Submit</button>
                </div>

                <div ng-controller="reserveJoinCtrl" ng-show="iPageMode == 2">
                    Join stuff
                    <input ng-model="sInputResvCode"/>
                    <button ng-click="onSubmit()">Submit</button>
                </div>

                <div ng-show="iPageMode">
                    <button ng-click="onCancel()">Cancel</button>
                </div>

            </div>
            <div ng-controller="reserveListCtrl" ng-show="oCommonData.sResvCode">
                Hello! {{ oCommonData.sResvCode }}

                <ul>
                    <li ng-repeat="opponent in opponents">
                        <span>{{ opponent.name }}</span>
                        <ul>
                            <li ng-repeat="resv in opponent.resvs">
                                <span>{{resv.state}}</span>
                            </li>
                        </ul>
                        <button ng-click="onOpponentSelected()">Select</button>
                    </li>
                </ul>

                <div ng-controller="reserveItemCtrl">

                </div>
            </div>
        </div>
    </body>
</html>
